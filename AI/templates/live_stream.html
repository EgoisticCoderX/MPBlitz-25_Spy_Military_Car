<!-- Code2: Modified HTML/JS Frontend (STABILITY FIX)
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Military Detection Live Stream</title>
    
    <style>
        body{font-family:'Arial',sans-serif;background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);margin:0;padding:20px;color:white}
        .container{max-width:1200px;margin:0 auto}h1{text-align:center;margin-bottom:20px}
        .stream-container{text-align:center;margin-bottom:20px}#videoStream{width:100%;max-width:800px;height:auto;border-radius:15px;background-color:#000;border:3px solid rgba(255,255,255,.2)}
        .control-panel{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;padding:20px;background:rgba(0,0,0,.3);border-radius:10px;margin-bottom:20px;align-items:center}
        .control-group{display:flex;flex-direction:column;align-items:center}
        .control-group label{font-weight:700;margin-bottom:5px}
        input[type=text],select{padding:10px;border-radius:8px;border:1px solid #ccc;color:#000}
        .btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:700;transition:all .3s ease}
        .btn-primary{background:linear-gradient(45deg,#4CAF50,#45a049);color:#fff}
        .btn-danger{background:linear-gradient(45deg,#f44336,#da190b);color:#fff}
        .status{text-align:center;margin:15px 0;padding:10px;border-radius:8px;font-weight:700;display:none}
        .status.success{background:rgba(76,175,80,.3);border:1px solid #4CAF50}.status.error{background:rgba(244,67,54,.3);border:1px solid #f44336}
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è ESP32 Military Detection System</h1>
        <div id="statusMessage" class="status"></div>
        <div class="stream-container"><img id="videoStream" alt="Live Stream"></div>

        <div class="control-panel">
            <div class="control-group"><label for="esp32Url">ESP32 IP</label><input type="text" id="esp32Url" value="192.168.29.177"></div>
            <button class="btn btn-primary" onclick="startStream()">üöÄ Start</button>
            <button class="btn btn-danger" onclick="stopStream()">‚èπÔ∏è Stop</button>
            <div class="control-group">
                <label for="modelSelect">Detection Model</label>
                <select id="modelSelect" onchange="setActiveModel()">
                    <option value="all">All Models</option>
                    {% for key, model in models.items() %}<option value="{{ key }}">{{ model.name }}</option>{% endfor %}
                </select>
            </div>
            <div class="control-group">
                <label for="brightnessSlider">Flashlight: <span id="brightnessValue">0</span></label>
               
                <!-- === KEY FIX: Using 'onchange' to prevent flooding the ESP32   ===
                <!-- =============================================================== 
                <input type="range" id="brightnessSlider" min="0" max="255" value="0" 
                       oninput="document.getElementById('brightnessValue').textContent=this.value" 
                       onchange="setBrightness(this.value)">
            </div>
        </div>
    </div>

    <script>
        let streamActive = false;
        document.addEventListener("DOMContentLoaded", () => {document.getElementById('videoStream').src='/video_feed';});
        function showStatus(m,t,d=4000){const s=document.getElementById('statusMessage');s.textContent=m;s.className=`status ${t}`;s.style.display='block';if(d>0)setTimeout(()=>{s.style.display='none'},d)}
        async function startStream(){if(streamActive)return;const u=document.getElementById('esp32Url').value.trim();if(!u)return;showStatus('Starting...','info');const r=await fetch('/start_stream',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({esp32_url:`http://${u}`})});if(r.ok){streamActive=true;showStatus('Stream started','success')}}
        async function stopStream(){if(!streamActive)return;await fetch('/stop_stream',{method:'POST'});streamActive=false;showStatus('Stream stopped','info')}
        async function setActiveModel(){if(!streamActive){showStatus('Start stream first','error');return};const k=document.getElementById('modelSelect').value;await fetch('/set_active_model',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model_key:k})});showStatus(`Model set to: ${k}`,'info')}
        async function setBrightness(v){const u=document.getElementById('esp32Url').value.trim();if(!u)return;showStatus(`Setting brightness to ${v}...`,'info',1000);fetch('/set_brightness',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({esp32_url:`http://${u}`,level:parseInt(v)})}).catch(e=>console.error(e))}
    </script>
</body>
</html>  -->
<!-- Code2: Modified HTML/JS Frontend (INTERACTIVE) -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Military Detection Live Stream</title>
    <!-- The general CSS is unchanged -->
    <style>
        body{font-family:'Arial',sans-serif;background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);margin:0;padding:20px;color:white}.container{max-width:1200px;margin:0 auto}h1{text-align:center;margin-bottom:20px}.stream-container{text-align:center;margin-bottom:20px;position:relative}#videoStream{width:100%;max-width:800px;height:auto;border-radius:15px;background-color:#000;border:3px solid rgba(255,255,255,.2)}.control-panel{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;padding:20px;background:rgba(0,0,0,.3);border-radius:10px;margin-bottom:20px;align-items:center}.control-group{display:flex;flex-direction:column;align-items:center}.control-group label{font-weight:700;margin-bottom:5px}input[type=text],select{padding:10px;border-radius:8px;border:1px solid #ccc;color:#000}.btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:700;transition:all .3s ease}.btn-primary{background:linear-gradient(45deg,#4CAF50,#45a049);color:#fff}.btn-danger{background:linear-gradient(45deg,#f44336,#da190b);color:#fff}.status{text-align:center;margin:15px 0;padding:10px;border-radius:8px;font-weight:700;display:none}.status.success{background:rgba(76,175,80,.3);border:1px solid #4CAF50}.status.error{background:rgba(244,67,54,.3);border:1px solid #f44336}
        
        /* --- NEW CSS for the confirmation dialog --- */
        #confirmation-dialog {
            display: none; /* Hidden by default */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 69, 0, 0.85); /* Bright orange */
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 0 25px rgba(0,0,0,0.5);
            border: 3px solid #FFF;
            z-index: 100;
        }
        #confirmation-dialog h3 { margin-top: 0; font-size: 1.8em; }
        #confirmation-dialog .btn-continue { background: #fff; color: #000; padding: 15px 30px; font-size: 1.2em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è ESP32 Military Detection System</h1>
        <div id="statusMessage" class="status"></div>
        <div class="stream-container">
            <img id="videoStream" alt="Live Stream">
            <!-- NEW Confirmation Dialog Element -->
            <div id="confirmation-dialog">
                <h3>DETECTION!</h3>
                <p>System paused. Review the frame.</p>
                <button class="btn btn-continue" onclick="resumeStream()">‚ñ∂ Continue</button>
            </div>
        </div>
        <div class="control-panel">
            <!-- Controls are unchanged -->
            <div class="control-group"><label for="esp32Url">ESP32 IP</label><input type="text" id="esp32Url" value="192.168.29.177"></div><button class="btn btn-primary" onclick="startStream()">üöÄ Start</button><button class="btn btn-danger" onclick="stopStream()">‚èπÔ∏è Stop</button><div class="control-group"><label for="modelSelect">Detection Model</label><select id="modelSelect" onchange="setActiveModel()"><option value="all">All Models</option>{% for k,m in models.items() %}<option value="{{k}}">{{m.name}}</option>{% endfor %}</select></div><div class="control-group"><label for="brightnessSlider">Flashlight: <span id="brightnessValue">0</span></label><input type="range" id="brightnessSlider" min="0" max="255" value="0" oninput="document.getElementById('brightnessValue').textContent=this.value" onchange="setBrightness(this.value)"></div>
        </div>
    </div>

    <script>
        let streamActive = false;
        let statusInterval = null; // To hold the interval timer
        
        document.addEventListener("DOMContentLoaded",() => {document.getElementById('videoStream').src='/video_feed'});
        
        function showStatus(m,t,d=4000){const s=document.getElementById('statusMessage');s.textContent=m;s.className=`status ${t}`;s.style.display='block';if(d>0)setTimeout(()=>s.style.display='none',d)}
        
        async function startStream() {
            if (streamActive) return;
            const u=document.getElementById('esp32Url').value.trim();if(!u)return;
            showStatus('Starting...','info');
            const r=await fetch('/start_stream',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({esp32_url:`http://${u}`})});
            if(r.ok){
                streamActive=true; showStatus('Stream started','success');
                // Start polling for status when stream starts
                if(statusInterval) clearInterval(statusInterval);
                statusInterval = setInterval(pollStatus, 1500);
            }
        }
        
        async function stopStream() {
            if (!streamActive) return;
            await fetch('/stop_stream',{method:'POST'}); streamActive=false;
            showStatus('Stream stopped','info');
            // Stop polling for status
            if(statusInterval) clearInterval(statusInterval);
            document.getElementById('confirmation-dialog').style.display = 'none'; // Hide dialog on stop
        }
        
        // --- NEW AND MODIFIED JAVASCRIPT FUNCTIONS ---
        
        /**
         * This function runs every 1.5 seconds to check the backend's state.
         */
        async function pollStatus() {
            if (!streamActive) return;
            try {
                const response = await fetch('/get_status');
                const data = await response.json();
                const dialog = document.getElementById('confirmation-dialog');
                
                if (data.state === 'PAUSED_FOR_CONFIRMATION') {
                    dialog.style.display = 'block'; // Show the "Continue" button
                } else {
                    dialog.style.display = 'none';  // Hide it
                }
            } catch (e) {
                console.error("Status poll failed:", e);
            }
        }
        
        /**
         * This is called by the "Continue" button.
         */
        async function resumeStream() {
            document.getElementById('confirmation-dialog').style.display = 'none'; // Hide immediately for responsiveness
            await fetch('/resume_stream', { method: 'POST' });
            showStatus('Resuming...', 'info', 1000);
        }

        // Other functions are unchanged...
        async function setActiveModel(){if(!streamActive){showStatus('Start stream first','error');return};const k=document.getElementById('modelSelect').value;await fetch('/set_active_model',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model_key:k})});showStatus(`Model set to: ${k}`,'info')}
        async function setBrightness(v){const u=document.getElementById('esp32Url').value.trim();if(!u)return;fetch('/set_brightness',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({esp32_url:`http://${u}`,level:parseInt(v)})}).catch(e=>console.error(e))}
    </script>
</body>
</html>